# vkstatbot

## Описание
Бот для VK по сбору статистики о лидах среди управляемых сообщества и статистики
рекламного кабинета.

## Требования 
 - PHP 7.1+
 - Зависимости
 - VK_API 5.110

## Запуск в Docker
Проект можно запустить в Docker (Nginx, PHP-FPM, PostgreSQL):
```bash
docker-compose up --build
``` 

## Инструкция
Для начала нужно создать и заполнить `config.php`. За образец нужно взять `config.default.php`. 
Рассмотрим, как получить параметры:
- `community_token` можно получить, перейдя в сообществе в `Управление > Работа с API > Ключи доступа`, 
где можно создать ключ (необходимы только права на сообщения);
- `group_id` - id той группы, с которой связан бот, можно получить в настройках сообщества;
- `app_id` и `app_secret` - параметры, относящиеся к приложению
(нужно для авторизации от имени пользователя для доступа к РК), получить можно, создав `Встраиваемое приложение` 
[тут](https://vk.com/editapp?act=create);
    - в Настройках приложения нужно включить `Open API` 
    и указать ссылку, по которой отвечает бот, и домен сайта, где он располагается;
- `token_file` - имя файла, в котором сохраняется токен пользователя, можно указать любое;
- `redirect_uri` - ссылка, использующаяся для авторизации пользователя, должна указывать на `auth.php`;
- `api_v` - совместимая версия `VK API`;
- `access_array` - массив, содержащий id пользователей, которым разрешено получать от бота статистику.
- `account_id` - id рекламного кабинета VK, смотреть в настройках РК; 
- `pg_user` - пользователь `PostgreSQL`, если приложение запускается в Docker, пользователь указывается 
в `config/db_env`;
- `pg_pass` - пароль от `PostgreSQL`, если приложение запускается в Docker, пароль указывается 
в `config/db_env`;
- `communities` - список сообществ, в которых нужно регистрировать сообщения для сбора статистики 
по лидам, представляет собой словарь, сопоставляющий id группы
параметрам `callback_token` и `callback_secret`;
    - `callback_token` и `callback_secret` - параметры необходимые для 
    Callback API(нужен для регистрации ботом сообщений), можно получить в сообществе, перейдя в `
    Управление > Работа с API > Callback API` (секретный и ключ и возвращаемая строка).
    
Далее нужно заполнить БД данными об уже существующих лидах. Для этого нужно указать 
в `scripts/messages.py` данные БД, а затем запустить этот скрипт для каждой группы:
```bash
cd scripts
python3.8 -m venv venv
. venv/bin/activate
pip install -r requirements.txt
python messages.py <group_id> <access_token>
```
Где `<group_id>` - id группы, а `<acces_token>` - ее токен.
